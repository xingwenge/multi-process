#!/usr/bin/env php
<?php
require_once __DIR__. '/../vendor/autoload.php';

use Monolog\Formatter\LineFormatter;
use Monolog\Handler\StreamHandler;
use xingwenge\multiprocess\Common\Container;
use xingwenge\multiprocess\Core\Master;
use xingwenge\multiprocess\Common\ConfigReader;
use xingwenge\multiprocess\Common\Logger;

/**
 * @usage
 *  ./bin/multiprocessd -c ./bin/demo.yaml
 */

try {
    $param = getopt('c:');

    $container = Container::instance();

    # config
    $configYamlFile = isset($param['c'])? $param['c']: './config.yaml';
    $container->get(ConfigReader::class)
        ->setConfigByYaml($configYamlFile)
        ->checkConfig();

    # logger
    $logFormatter = new LineFormatter("[%datetime%] %channel%.%level_name%: %message% %context% %extra%\n", "Y-m-d H:i:s");
    $container->get(Logger::class)
        ->setName('multi-process')
        ->setTimezone(new \DateTimeZone('Asia/Shanghai'))
        ->setHandlers([
            (new StreamHandler('php://stdout'))->setFormatter($logFormatter),
            (new StreamHandler('/logs/run.log'))->setFormatter($logFormatter),
        ]);

    # master
    $master = $container->get(Master::class);
    $master->start();

} catch (\Exception $e) {
    echo $e->getMessage(), PHP_EOL;
}
